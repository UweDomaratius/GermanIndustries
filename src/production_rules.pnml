////////////////////////////////////////////////////////////////////////////////
// Placeholder produce rule that does not consume or produce anything
////////////////////////////////////////////////////////////////////////////////
produce(empty_produce, [], [])

////////////////////////////////////////////////////////////////////////////////
// if < 30% of produced goods were transported, decrease production by 5
// if < 40% of produced goods were transported, decrease production by 1
// if > 60% of produced goods were transported, increase production by 1
// if > 75% of produced goods were transported, increase production by 5
// Precondition: Temp storage registers hold the current production level and
// the maximum possible production.
// Result is written into temporary storage register 0x100 and returned as 
// CB result.
// The result is always >=4 (to prevent the industry from closing).
// The result is always <= maximum production level (which may be statically or 
// dynamically computed)
////////////////////////////////////////////////////////////////////////////////
switch(FEAT_INDUSTRIES, SELF, set_new_production, 
	[ 
	  LOAD_TEMP(TEMP_REGISTER_TRANSPORTED_LAST_MONTH_PCT_CARGO0) < 30 ? STORE_PERM(max(LOAD_PERM(PERM_REGISTER_PRODUCTION_AMOUNT) - 5,4), PERM_REGISTER_PRODUCTION_AMOUNT) : 
	  LOAD_TEMP(TEMP_REGISTER_TRANSPORTED_LAST_MONTH_PCT_CARGO0) < 40 ? STORE_PERM(max(LOAD_PERM(PERM_REGISTER_PRODUCTION_AMOUNT) - 1,4), PERM_REGISTER_PRODUCTION_AMOUNT) : 
	  LOAD_TEMP(TEMP_REGISTER_TRANSPORTED_LAST_MONTH_PCT_CARGO0) < 75 ? STORE_PERM(min(LOAD_PERM(PERM_REGISTER_PRODUCTION_AMOUNT)+1,LOAD_TEMP(TEMP_REGISTER_MAXIMUM_PRIMARY_PRODUCTION)), PERM_REGISTER_PRODUCTION_AMOUNT) : 
	                                                                    STORE_PERM(min(LOAD_PERM(PERM_REGISTER_PRODUCTION_AMOUNT)+5,LOAD_TEMP(TEMP_REGISTER_MAXIMUM_PRIMARY_PRODUCTION)), PERM_REGISTER_PRODUCTION_AMOUNT),
																		
	  LOAD_TEMP(TEMP_REGISTER_TRANSPORTED_LAST_MONTH_PCT_CARGO0) < 30 ? STORE_TEMP(max(LOAD_TEMP(TEMP_REGISTER_CURRENT_PRODUCTION_LEVEL) - 5,4) << 16, TEMP_REGISTER_CB_RESULT_IND_PROD_SET_BY_0x100) : 
	  LOAD_TEMP(TEMP_REGISTER_TRANSPORTED_LAST_MONTH_PCT_CARGO0) < 40 ? STORE_TEMP(max(LOAD_TEMP(TEMP_REGISTER_CURRENT_PRODUCTION_LEVEL) - 1,4) << 16, TEMP_REGISTER_CB_RESULT_IND_PROD_SET_BY_0x100) : 
	  LOAD_TEMP(TEMP_REGISTER_TRANSPORTED_LAST_MONTH_PCT_CARGO0) < 75 ? STORE_TEMP(min(LOAD_TEMP(TEMP_REGISTER_CURRENT_PRODUCTION_LEVEL)+1,LOAD_TEMP(TEMP_REGISTER_MAXIMUM_PRIMARY_PRODUCTION)) << 16, TEMP_REGISTER_CB_RESULT_IND_PROD_SET_BY_0x100) : 
	  STORE_TEMP(min(LOAD_TEMP(TEMP_REGISTER_CURRENT_PRODUCTION_LEVEL)+5,LOAD_TEMP(TEMP_REGISTER_MAXIMUM_PRIMARY_PRODUCTION)) << 16, TEMP_REGISTER_CB_RESULT_IND_PROD_SET_BY_0x100)
	]) {
	return CB_RESULT_IND_PROD_SET_BY_0x100;
}

switch(FEAT_INDUSTRIES, SELF, change_production,
	[(LOAD_TEMP(TEMP_REGISTER_TRANSPORTED_LAST_MONTH_PCT_CARGO0) != 0 && 
	((LOAD_TEMP(TEMP_REGISTER_TRANSPORTED_LAST_MONTH_PCT_CARGO0) < 40) || LOAD_TEMP(TEMP_REGISTER_TRANSPORTED_LAST_MONTH_PCT_CARGO0) > 59))])
{
	1: set_new_production;
	return CB_RESULT_IND_PROD_NO_CHANGE;
}

////////////////////////////////////////////////////////////////////////////////
// Randomize initial production value for newly generated industries.
// monthly production: 96t min, 152t max (with default production scaling)
// Precondition: Temp storage register holds the maximum possible production.
// Returns the production value in game units (12-19).
// Value is <= maximum production value, which may also be lower than 12.
////////////////////////////////////////////////////////////////////////////////
switch(FEAT_INDUSTRIES, SELF, randomize_initial_production, 
	[
	STORE_PERM(min(12+getbits(extra_callback_info2, 0, 3),LOAD_TEMP(TEMP_REGISTER_MAXIMUM_PRIMARY_PRODUCTION)), PERM_REGISTER_PRODUCTION_AMOUNT),
	extra_callback_info2
	])
{
	return LOAD_PERM(PERM_REGISTER_PRODUCTION_AMOUNT);
}

////////////////////////////////////////////////////////////////////////////////
// Extractive industries have resources which can be depleted. They are
// initialized upon construction of the industry and updated with every produce
// command. If the resources are depleted, the industry closes.
////////////////////////////////////////////////////////////////////////////////
switch(FEAT_INDUSTRIES, SELF, initialize_extractive_resources,
	[
	STORE_TEMP(param_primary_resource_factor == 0 ? 5 : param_primary_resource_factor, TEMP_REGISTER_PARAM_PRODUCTION_SCALE),
	STORE_PERM(LOAD_TEMP(TEMP_REGISTER_PARAM_PRODUCTION_SCALE)*250000 + getbits(extra_callback_info2, 3, 3)*LOAD_TEMP(TEMP_REGISTER_PARAM_PRODUCTION_SCALE)*250000,PERM_REGISTER_RESOURCES)
	]
)
{
	return;
}

////////////////////////////////////////////////////////////////////////////////
// Initialize temporary registers for the actual produce calls of primary industries
////////////////////////////////////////////////////////////////////////////////
switch(FEAT_INDUSTRIES, SELF, init_primary_production,
[	// load the GRF parameter for production scaling percentage and ensure it's not 0
	STORE_TEMP(param_primary_production == 0 ? 100 : param_primary_production, TEMP_REGISTER_PARAM_PRODUCTION_SCALE),
	 // store the theoretical amount of production (production level * scaling percentage)
	 STORE_TEMP(LOAD_PERM(PERM_REGISTER_PRODUCTION_AMOUNT) * LOAD_TEMP(TEMP_REGISTER_PARAM_PRODUCTION_SCALE) / 100, TEMP_REGISTER_PRODUCTION_AMOUNT),
	 // reduce production amount if remaining resources are less than what should be produced
	 STORE_TEMP(min(LOAD_PERM(PERM_REGISTER_RESOURCES),LOAD_TEMP(TEMP_REGISTER_PRODUCTION_AMOUNT)),TEMP_REGISTER_PRODUCTION_AMOUNT),
	 // update the value for remaining resources
	 STORE_PERM(max(LOAD_PERM(PERM_REGISTER_RESOURCES) - LOAD_TEMP(TEMP_REGISTER_PRODUCTION_AMOUNT),0),PERM_REGISTER_RESOURCES)])	 
{ return; }

////////////////////////////////////////////////////////////////////////////////
// Calculate the total production as sum of 10% of each incoming waiting cargo
// Relevant for industries that work as soon as 1 incoming cargo is available
// Requires TEMP_REGISTER_PRODUCTION_RAWx to be set - call 
// calculate_raw_material_usage() before
////////////////////////////////////////////////////////////////////////////////
switch(FEAT_INDUSTRIES, SELF, calculate_total_production,
	[STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW0), TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW1) + LOAD_TEMP(TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT), TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW2) + LOAD_TEMP(TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT), TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW3) + LOAD_TEMP(TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT), TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW4) + LOAD_TEMP(TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT), TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW5) + LOAD_TEMP(TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT), TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW6) + LOAD_TEMP(TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT), TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW7) + LOAD_TEMP(TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT), TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW8) + LOAD_TEMP(TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT), TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT)
]
)
{
}

////////////////////////////////////////////////////////////////////////////////
// Calculate the number of waiting cargos for an industry
// Precondition: Have the values stored in TEMP_REGISTER_INCOMING_CARGO_WAITINGx
////////////////////////////////////////////////////////////////////////////////
switch(FEAT_INDUSTRIES, SELF, calculate_number_of_waiting_cargos,
	[STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING0) > 0 ? 1 : 0, TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING1) > 0 ? 1 + LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS) : LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS), TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING2) > 0 ? 1 + LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS) : LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS), TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING3) > 0 ? 1 + LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS) : LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS), TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING4) > 0 ? 1 + LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS) : LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS), TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING5) > 0 ? 1 + LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS) : LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS), TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING6) > 0 ? 1 + LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS) : LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS), TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING7) > 0 ? 1 + LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS) : LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS), TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING8) > 0 ? 1 + LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS) : LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS), TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS)
	]
)
{
}

////////////////////////////////////////////////////////////////////////////////
// Calculate the usage of raw materials based on 10% of the available inputs
////////////////////////////////////////////////////////////////////////////////
switch(FEAT_INDUSTRIES, SELF, calculate_raw_material_usage,
	[STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING0) > 0 ? max(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING0)*10/100,1) : 0, TEMP_REGISTER_PRODUCTION_RAW0),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING1) > 0 ? max(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING1)*10/100,1) : 0, TEMP_REGISTER_PRODUCTION_RAW1),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING2) > 0 ? max(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING2)*10/100,1) : 0, TEMP_REGISTER_PRODUCTION_RAW2),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING3) > 0 ? max(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING3)*10/100,1) : 0, TEMP_REGISTER_PRODUCTION_RAW3),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING4) > 0 ? max(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING4)*10/100,1) : 0, TEMP_REGISTER_PRODUCTION_RAW4),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING5) > 0 ? max(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING5)*10/100,1) : 0, TEMP_REGISTER_PRODUCTION_RAW5),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING6) > 0 ? max(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING6)*10/100,1) : 0, TEMP_REGISTER_PRODUCTION_RAW6),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING7) > 0 ? max(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING7)*10/100,1) : 0, TEMP_REGISTER_PRODUCTION_RAW7),
	 STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING8) > 0 ? max(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING8)*10/100,1) : 0, TEMP_REGISTER_PRODUCTION_RAW8)
	]
)
{
}

switch(FEAT_INDUSTRIES, SELF, initialize_last_served_date,
	[STORE_PERM(1, PERM_REGISTER_LAST_SERVED00),
	 STORE_PERM(1, PERM_REGISTER_LAST_SERVED01),
	 STORE_PERM(1, PERM_REGISTER_LAST_SERVED02),
	 STORE_PERM(1, PERM_REGISTER_LAST_SERVED03),
	 STORE_PERM(1, PERM_REGISTER_LAST_SERVED04),
	 STORE_PERM(1, PERM_REGISTER_LAST_SERVED05),
	 STORE_PERM(1, PERM_REGISTER_LAST_SERVED06),
	 STORE_PERM(1, PERM_REGISTER_LAST_SERVED07),
	 STORE_PERM(1, PERM_REGISTER_LAST_SERVED08),
	 STORE_PERM(1, PERM_REGISTER_LAST_SERVED09),
	 STORE_PERM(1, PERM_REGISTER_LAST_SERVED10),
	 STORE_PERM(1, PERM_REGISTER_LAST_SERVED11)
	])
{
}

switch(FEAT_INDUSTRIES, SELF, update_last_served_date, 
	[STORE_PERM(LOAD_PERM(PERM_REGISTER_LAST_SERVED01), PERM_REGISTER_LAST_SERVED00),
	 STORE_PERM(LOAD_PERM(PERM_REGISTER_LAST_SERVED02), PERM_REGISTER_LAST_SERVED01),
	 STORE_PERM(LOAD_PERM(PERM_REGISTER_LAST_SERVED03), PERM_REGISTER_LAST_SERVED02),
	 STORE_PERM(LOAD_PERM(PERM_REGISTER_LAST_SERVED04), PERM_REGISTER_LAST_SERVED03),
	 STORE_PERM(LOAD_PERM(PERM_REGISTER_LAST_SERVED05), PERM_REGISTER_LAST_SERVED04),
	 STORE_PERM(LOAD_PERM(PERM_REGISTER_LAST_SERVED06), PERM_REGISTER_LAST_SERVED05),
	 STORE_PERM(LOAD_PERM(PERM_REGISTER_LAST_SERVED07), PERM_REGISTER_LAST_SERVED06),
	 STORE_PERM(LOAD_PERM(PERM_REGISTER_LAST_SERVED08), PERM_REGISTER_LAST_SERVED07),
	 STORE_PERM(LOAD_PERM(PERM_REGISTER_LAST_SERVED09), PERM_REGISTER_LAST_SERVED08),
	 STORE_PERM(LOAD_PERM(PERM_REGISTER_LAST_SERVED10), PERM_REGISTER_LAST_SERVED09),
	 STORE_PERM(LOAD_PERM(PERM_REGISTER_LAST_SERVED11), PERM_REGISTER_LAST_SERVED10)
	])
{
}

random_switch(FEAT_INDUSTRIES, SELF, random_chance_to_close_industry)
{
	49: return CB_RESULT_IND_PROD_NO_CHANGE;
	1: return CB_RESULT_IND_PROD_CLOSE;
}

switch(FEAT_INDUSTRIES, SELF, check_secondary_industry_closure,
	[STORE_TEMP(LOAD_PERM(PERM_REGISTER_LAST_SERVED00) != 0, TEMP_REGISTER_PRODUCTION_LAST_YEAR),
	 STORE_TEMP(LOAD_PERM(PERM_REGISTER_LAST_SERVED01) != 0 || LOAD_TEMP(TEMP_REGISTER_PRODUCTION_LAST_YEAR), TEMP_REGISTER_PRODUCTION_LAST_YEAR),
	 STORE_TEMP(LOAD_PERM(PERM_REGISTER_LAST_SERVED02) != 0 || LOAD_TEMP(TEMP_REGISTER_PRODUCTION_LAST_YEAR), TEMP_REGISTER_PRODUCTION_LAST_YEAR),
	 STORE_TEMP(LOAD_PERM(PERM_REGISTER_LAST_SERVED03) != 0 || LOAD_TEMP(TEMP_REGISTER_PRODUCTION_LAST_YEAR), TEMP_REGISTER_PRODUCTION_LAST_YEAR),
	 STORE_TEMP(LOAD_PERM(PERM_REGISTER_LAST_SERVED04) != 0 || LOAD_TEMP(TEMP_REGISTER_PRODUCTION_LAST_YEAR), TEMP_REGISTER_PRODUCTION_LAST_YEAR),
	 STORE_TEMP(LOAD_PERM(PERM_REGISTER_LAST_SERVED05) != 0 || LOAD_TEMP(TEMP_REGISTER_PRODUCTION_LAST_YEAR), TEMP_REGISTER_PRODUCTION_LAST_YEAR),
	 STORE_TEMP(LOAD_PERM(PERM_REGISTER_LAST_SERVED06) != 0 || LOAD_TEMP(TEMP_REGISTER_PRODUCTION_LAST_YEAR), TEMP_REGISTER_PRODUCTION_LAST_YEAR),
	 STORE_TEMP(LOAD_PERM(PERM_REGISTER_LAST_SERVED07) != 0 || LOAD_TEMP(TEMP_REGISTER_PRODUCTION_LAST_YEAR), TEMP_REGISTER_PRODUCTION_LAST_YEAR),
	 STORE_TEMP(LOAD_PERM(PERM_REGISTER_LAST_SERVED08) != 0 || LOAD_TEMP(TEMP_REGISTER_PRODUCTION_LAST_YEAR), TEMP_REGISTER_PRODUCTION_LAST_YEAR),
	 STORE_TEMP(LOAD_PERM(PERM_REGISTER_LAST_SERVED09) != 0 || LOAD_TEMP(TEMP_REGISTER_PRODUCTION_LAST_YEAR), TEMP_REGISTER_PRODUCTION_LAST_YEAR),
	 STORE_TEMP(LOAD_PERM(PERM_REGISTER_LAST_SERVED10) != 0 || LOAD_TEMP(TEMP_REGISTER_PRODUCTION_LAST_YEAR), TEMP_REGISTER_PRODUCTION_LAST_YEAR),
	 STORE_TEMP(LOAD_PERM(PERM_REGISTER_LAST_SERVED11) != 0 || LOAD_TEMP(TEMP_REGISTER_PRODUCTION_LAST_YEAR), TEMP_REGISTER_PRODUCTION_LAST_YEAR),
	 LOAD_TEMP(TEMP_REGISTER_PRODUCTION_LAST_YEAR) || param_forbid_industry_closure
	])
{
	1: return CB_RESULT_IND_PROD_NO_CHANGE;
	random_chance_to_close_industry;
}

switch(FEAT_INDUSTRIES, SELF, store_debug_production_data,
	[STORE_PERM(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_WAITING_CARGOS), PERM_REGISTER_DBG_NUMBER_OF_WAITING_CARGOS),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_CURRENT_PRODUCTION_AMOUNT), PERM_REGISTER_DBG_CURRENT_PRODUCTION_AMOUNT),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_PARAM_PRODUCTION_SCALE), PERM_REGISTER_DBG_PRODUCTION_SCALE),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING0), PERM_REGISTER_DBG_INCOMING_CARGO_WAITING0),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING1), PERM_REGISTER_DBG_INCOMING_CARGO_WAITING1),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING2), PERM_REGISTER_DBG_INCOMING_CARGO_WAITING2),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING3), PERM_REGISTER_DBG_INCOMING_CARGO_WAITING3),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING4), PERM_REGISTER_DBG_INCOMING_CARGO_WAITING4),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING5), PERM_REGISTER_DBG_INCOMING_CARGO_WAITING5),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING6), PERM_REGISTER_DBG_INCOMING_CARGO_WAITING6),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING7), PERM_REGISTER_DBG_INCOMING_CARGO_WAITING7),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_INCOMING_CARGO_WAITING8), PERM_REGISTER_DBG_INCOMING_CARGO_WAITING8),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW0), PERM_REGISTER_DBG_PRODUCTION_RAW0),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW1), PERM_REGISTER_DBG_PRODUCTION_RAW1),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW2), PERM_REGISTER_DBG_PRODUCTION_RAW2),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW3), PERM_REGISTER_DBG_PRODUCTION_RAW3),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW4), PERM_REGISTER_DBG_PRODUCTION_RAW4),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW5), PERM_REGISTER_DBG_PRODUCTION_RAW5),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW6), PERM_REGISTER_DBG_PRODUCTION_RAW6),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW7), PERM_REGISTER_DBG_PRODUCTION_RAW7),
	 STORE_PERM(LOAD_TEMP(TEMP_REGISTER_PRODUCTION_RAW8), PERM_REGISTER_DBG_PRODUCTION_RAW8)
	])
{
}

////////////////////////////////////////////////////////////////////////////////
// Check the stockpile of the industry and return 1 if the stockpile exceeds 60k units
////////////////////////////////////////////////////////////////////////////////
switch(FEAT_INDUSTRIES, SELF, stop_accept_cargo, getbits(extra_callback_info2, 0, 8))
{
	ACID: (incoming_cargo_waiting("ACID") > 60000) ? 0 : 1;
	ALUM: (incoming_cargo_waiting("ALUM") > 60000) ? 0 : 1;
	AORE: (incoming_cargo_waiting("AORE") > 60000) ? 0 : 1;
	BIOM: (incoming_cargo_waiting("BIOM") > 60000) ? 0 : 1;
	C2H4: (incoming_cargo_waiting("C2H4") > 60000) ? 0 : 1;
	CBLK: (incoming_cargo_waiting("CBLK") > 60000) ? 0 : 1;
	CHLO: (incoming_cargo_waiting("CHLO") > 60000) ? 0 : 1;
	COAL: (incoming_cargo_waiting("COAL") > 60000) ? 0 : 1;
	COAT: (incoming_cargo_waiting("COAT") > 60000) ? 0 : 1;
	COKE: (incoming_cargo_waiting("COKE") > 60000) ? 0 : 1;
	COPR: (incoming_cargo_waiting("COPR") > 60000) ? 0 : 1;
	CORE: (incoming_cargo_waiting("CORE") > 60000) ? 0 : 1;
	ENSP: (incoming_cargo_waiting("ENSP") > 60000) ? 0 : 1;
	FISH: (incoming_cargo_waiting("FISH") > 60000) ? 0 : 1;
	FRUT: (incoming_cargo_waiting("FRUT") > 60000) ? 0 : 1;
	GLAS: (incoming_cargo_waiting("GLAS") > 60000) ? 0 : 1;
	GRAI: (incoming_cargo_waiting("GRAI") > 60000) ? 0 : 1;
	H2__: (incoming_cargo_waiting("H2__") > 60000) ? 0 : 1;
	IORE: (incoming_cargo_waiting("IORE") > 60000) ? 0 : 1;
	LIME: (incoming_cargo_waiting("LIME") > 60000) ? 0 : 1;
	LVST: (incoming_cargo_waiting("LVST") > 60000) ? 0 : 1;
	LYE_: (incoming_cargo_waiting("LYE_") > 60000) ? 0 : 1;
	MILK: (incoming_cargo_waiting("MILK") > 60000) ? 0 : 1;
	MNSP: (incoming_cargo_waiting("MNSP") > 60000) ? 0 : 1;
	N2__: (incoming_cargo_waiting("N2__") > 60000) ? 0 : 1;
	NH3_: (incoming_cargo_waiting("NH3_") > 60000) ? 0 : 1;
	O2__: (incoming_cargo_waiting("O2__") > 60000) ? 0 : 1;
	OIL_: (incoming_cargo_waiting("OIL_") > 60000) ? 0 : 1;
	PAPR: (incoming_cargo_waiting("PAPR") > 60000) ? 0 : 1;
	PLAS: (incoming_cargo_waiting("PLAS") > 60000) ? 0 : 1;
	PORE: (incoming_cargo_waiting("PORE") > 60000) ? 0 : 1;
	QLME: (incoming_cargo_waiting("QLME") > 60000) ? 0 : 1;
	RCYC: (incoming_cargo_waiting("RCYC") > 60000) ? 0 : 1;
	RFPR: (incoming_cargo_waiting("RFPR") > 60000) ? 0 : 1;
	RUBR: (incoming_cargo_waiting("RUBR") > 60000) ? 0 : 1;
	SALT: (incoming_cargo_waiting("SALT") > 60000) ? 0 : 1;
	SAND: (incoming_cargo_waiting("SAND") > 60000) ? 0 : 1;
	SASH: (incoming_cargo_waiting("SASH") > 60000) ? 0 : 1;
	SCMT: (incoming_cargo_waiting("SCMT") > 60000) ? 0 : 1;
	STEL: (incoming_cargo_waiting("STEL") > 60000) ? 0 : 1;
	STSH: (incoming_cargo_waiting("STSH") > 60000) ? 0 : 1;
	STWR: (incoming_cargo_waiting("STWR") > 60000) ? 0 : 1;
	SULP: (incoming_cargo_waiting("SULP") > 60000) ? 0 : 1;
	TEXT: (incoming_cargo_waiting("TEXT") > 60000) ? 0 : 1;
	TYRE: (incoming_cargo_waiting("TYRE") > 60000) ? 0 : 1;
	VBOD: (incoming_cargo_waiting("VBOD") > 60000) ? 0 : 1;
	VENG: (incoming_cargo_waiting("VENG") > 60000) ? 0 : 1;
	VPTS: (incoming_cargo_waiting("VPTS") > 60000) ? 0 : 1;
	WDPR: (incoming_cargo_waiting("WDPR") > 60000) ? 0 : 1;
	WOOD: (incoming_cargo_waiting("WOOD") > 60000) ? 0 : 1;
	WOOL: (incoming_cargo_waiting("WOOL") > 60000) ? 0 : 1;
	ZINC: (incoming_cargo_waiting("ZINC") > 60000) ? 0 : 1;
	return 0;
}

switch(FEAT_INDUSTRIES, SELF, switch_stop_accept_cargo, param_stockpile_cap)
{
	1: stop_accept_cargo;
	return 1;
}

////////////////////////////////////////////////////////////////////////////////
// Count all industries on the map
////////////////////////////////////////////////////////////////////////////////
switch(FEAT_INDUSTRIES, SELF, count_industries,
	[
	STORE_TEMP(industry_count(0),TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(1), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(2), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(3), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(4), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(5), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(6), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(7), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(8), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(9), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(10), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(11), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(12), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(13), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(14), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(15), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(16), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(17), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(18), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(19), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(20), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(21), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(22), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(23), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(24), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(25), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(26), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(27), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(28), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(29), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(30), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(31), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(32), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(33), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(34), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(35), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(36), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(37), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(38), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(39), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(40), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(41), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(42), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(43), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(44), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(45), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(46), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(47), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(48), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(49), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(50), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(51), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(52), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(53), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(54), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(55), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(56), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(57), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(58), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(59), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(60), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(61), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(62), TEMP_REGISTER_NUMBER_OF_INDUSTRIES),
	STORE_TEMP(LOAD_TEMP(TEMP_REGISTER_NUMBER_OF_INDUSTRIES)+ industry_count(63), TEMP_REGISTER_NUMBER_OF_INDUSTRIES)
	]
)
{
	return;
}